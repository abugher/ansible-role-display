pulseaudio --start


# Enable HDMI audio and video output.
# Find the HDMI output, connected or not.
output="$(xrandr | awk '/^HDMI/ {print $1}' | head -n 1)"
# Wait for the monitor, then configure it.  Expect this to loop a long time if
# HDMI is unplugged connected to a disabled KVM port.
while ! xrandr | grep -A 1 "${output}" | tail -n 1 | grep -q '\*'; do
  sleep 1
  # Don't even try unless the monitor seems to be connected.
  if xrandr | grep -A 1 "${output}" | tail -n 1 | grep -q '^   '; then
    xrandr --output "${output}" --auto
  fi
# Do not background.  It may take a while to complete, but until the monitor is
# working, no one will miss the window manager.
done
# Enable only HDMI output.  (No laptop speakers, etc.)
hdmi_sound_enabled='no'
# Loop until HDMI audio output is found to configure.
while test 'no' == "${hdmi_sound_enabled}"; do
  for card in $(pactl list cards | awk -F '#' '/^Card/ {print $2}'); do
    # Disable everything.
    pactl set-card-profile "${card}" off
    # If it is HDMI, turn it on.
    if pactl set-card-profile "${card}" output:hdmi-stereo; then
      # Declare success.
      hdmi_sound_enabled='yes'
    fi
  done
done


if test 12 -eq $(date +%m) && test -e .christmas_video.mp4; then
  # Merry Christmas.
  mplayer -loop 0 -rootwin -volume 0 .christmas_video.mp4
else
  xscreensaver -nosplash
fi &

exec i3
